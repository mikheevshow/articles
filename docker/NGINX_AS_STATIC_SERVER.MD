# Как использовать официальный Docker образ NGINX.

NGINX это один самых популярных веб серверов в мире. NGINX очень быстр, может использоваться как в качестве веб сервера статического содежимого, так и в качестве сервера обратного проксирования.

Мы начнем с локального запуска статического веб-сервера, а затем создадим собственный образ для размещения нашего веб-сервера и файлов, которые он должен обслуживать. В заключение мы рассмотрим создание обратного прокси-сервера для простого REST API, а затем то, как поделиться этим образом с вашей командой.

## Подготовка

Для выполнения задания, нам понадобится выполнить следующие шаги:

- Создание бесплатного Docker аккаунта
  - Для регистрации аккаунта перейдите по [ссылке](https://hub.docker.com/)
- Запущенный локально Docker
  - [Инструкция по установке Docker](https://docs.docker.com/desktop/)
- IDE или текстовый редактор для редактирования файлов  

## Официальный NGINX образ

[Официальные образы Docker](https://docs.docker.com/docker-hub/official_images/) - это тщательно подобранный набор репозиториев Docker, размещенных в Docker Hub, которые были проверены на наличие уязвимостей и поддерживаются сотрудниками Docker и непосредственно разработчиками

Официальные образы - отличный вариант для новых пользователей Docker. Эти образы имеют четкую документацию, продвигают передовые практики и предназначены для наиболее распространенных случаев использования.

Давайте посмотрим на [официальный образ NGINX](https://hub.docker.com/_/nginx). Откройте браузер и войдите в [Docker](https://hub.docker.com/). Если у вас еще нет учетной записи Docker, вы можете создать ее [бесплатно](https://hub.docker.com/signup).

После входа в Docker введите «NGINX» в верхнюю строку поиска и нажмите клавишу ВВОД. Официальный образ NGINX должен быть первым в результатах поиска. Вы увидите метку «ОФИЦИАЛЬНЫЙ ОБРАЗ» (Official Image) в правом верхнем углу поисковой записи.

![hub-page](https://lh6.googleusercontent.com/FJh7W5WYZ06vCV241juS-hTPbyGgzkCJ3671kqEmW7-Vo2dOzRaTvUsFymqZiNtbktHq7JYU-1KsRd9fWxuIX5Aicvlz1UwzOp0ryR38NTwrnvhC4pAsnkg1UfJ4xWccgFgPj5Gj)

На странице образа вы найдете описание и документацию к нему. Также вы можете посмотреть все доступные теги, кликнув по вкладке `Tags`.

![hub-page](https://lh4.googleusercontent.com/ZEv4eCJE0TGSfOGX00FPwQLSyv54ofFTXHiF7uToshtJBFJax_GLscokjHwAsiND5odEkZIlHn_uPYaIs00-iad_r4q15YtfSkvGvAHiK7DAzSfJhhq_PEMpG8NtXpLOaN-r7JEF)


## Запуск базового веб-сервера

Давайте запустим базовый веб сервер, используя официальный образ NGINX. Для запуска контейнера выполните следующую команду.

```bash
$ docker run -it --rm -d -p 8080:80 --name web nginx
```

Данный командой вы запустили контейнер как демон (опция `-d`) и опубликовали его на порту 8080. Вы также присвоили контенеру имя _web_, используя опцию `-name`.

Откройте браузер и перейдите по ссылке [http://localhost:8080](http://localhost:8080), Вы должны увидеть начальную страницу NGINX

![nginx-start-page](https://lh4.googleusercontent.com/TBXwvnvDDxQAMJdPnPHkM8iG-z9_qKtjb7dfyu36eV1K0dutD5YE20v_9WRZUEvWHepXq86rbPKtMiBkZFVOsEk68iHA3X7uxmQ_Ponm87kqJhtexPALT-_A_K2fOCvoD3L9ks4g)

Это всё замечательно, но цель запуска веб-сервера - обслуживать наши собственные пользовательские файлы html, а не страницу приветствия NGINX.

Давайте остановим контейнер и посмотрим, как обслуживать наши собственные файлы html.

```bash
$ docker stop web
```

## Добавление кастомных файлов HTML

По умолчанию NGINX смотрит в директорию `/usr/share/nginx/html` внутри контейнера для обслуживания файлов статики. Нам нужно положить наши собственные html файлы в эту директорию.
Достаточно простой способ сделать это - использовать смонтированный том. С помощью смонтированных томов мы можем связать каталог на нашем локальном компьютере с каталогом в нашем работающем контейнере.

Давайте создадим html-страницу, а затем передадим ее в образ nginx.

Создайте каталог с именем site-content. Добавьте файл index.html в этот каталог и напишите в нем следующее:

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Docker Nginx</title>
</head>
<body>
  <h2>Hello from Nginx container</h2>
</body>
</html>
```

Теперь выполните команду, представленную ниже. Она выглядит почти также, как и команда выше, но теперь мы используем опцию `-v` для [связывания томов](https://docs.docker.com/storage/bind-mounts/). Таким образом мы монтируем локальный каталог `~/site-content` в каталог запущенного контейнера `/usr/share/nginx`  

```bash
$ docker run -it --rm -d -p 8080:80 --name web -v ~/site-content:/usr/share/nginx nginx
```

Откройте браузер и перейдите по ссылке [http://localhost:8080](http://localhost:8080), Вы должны увидеть только что созданную страницу.

![nginx-custom-page](https://lh6.googleusercontent.com/shpxmVQQqn5njc2YcYdN1Dc1_TJysumHjeSAcVms7kn4K2gLuWq5kJV2apj-LH319uiwzFUtAiz0XI0bqeQMo0eXma2v_XJliG5JNe9BdXo-w2UcTKZLyNVj1t0w_PWYqJALRgD5)

## Сборка кастомного образа NGINX

Связывание томов это отличный вариант, в случае, если вы работаете на локальной машине и хотите загрузить файлы статики в контейнер. Но что если мы хотим
передать образ вместе с файлами?

Есть несколько способов сделать это, но самый портируемый и простой из них - это скопировать html файлы в образ, создавая тем самым ваш собственный докер образ.

Для создания кастомного образа, должны создать `Dockerfile` в том же каталоге и добавить туда следующие команды:

```dockerfile
FROM nginx:latest
COPY ./index.html /usr/share/nginx/html/index.html
```

Мы начали сборку кастомного образа, используя базовый образ. На первой строке мы видим использование команды `FROM`. Мы подтянем образ `nginx:latest` на нашу машину, и, затем, на основе него построим наш собственный образ.

Следующей командой `COPY` мы копируем наш index.html в каталог `/usr/share/nginx/html` внутрь контейнера, перезатирая index.html по умолчанию, который предоставлен образом `nginx:latest`.

Некоторые могут заметить, что мы не добавлялм команды ENTRYPOINT или CMD в Dockerfile. Мы используем подкапотные `ENTRYPOINT` и `CMD` предоставленные базовым образом NGINX.

Для сборки нашего образа выполните команду:

```bash
$ docker build -t webserver .
```

Данная команда скажет Docker выполнить списко команд из Dockerfile. Процесс сборки образа в терминале может выглядеть примерно так:

![build-image](https://lh3.googleusercontent.com/2p49V4yAQHpimfNbMTL89xQiNPGP3xBakNrOhT2sRytiFa0IVVUAr_StlPS6n-zQFRZTZzK4pV4cjVg3mddoZnEpIwK2r_OJ_N_3iWsTchLPloBZdqm-FpBsOGhJwqka9DXrlIlD)

Теперь мы можем запустить новый образ в контейнере:

```bash
$ docker run -it --rm -d -p 8080:80 --name web webserver
```


Откройте браузер и перейдите по ссылке [http://localhost:8080](http://localhost:8080), убедитесь, что отображается страница, которую вы недавно создали.

## NGINX как обратный прокси-сервер

TBD
