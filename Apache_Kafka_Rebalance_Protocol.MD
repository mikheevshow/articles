# Протокол Ребалансировки Apache Kafka или Магия Внутри Ваших Потоковых Приложений

Начиная с Apache Kafka 2.3.0, внутренний протокол ребалансировки, который в особенности используется в Kafka Connect и потребителями (consumers), претерпел несколько важных изменений.

Протокол ребалансироваки это что-то не очень простое и, иногда, может выглядеть как магия. В этом посте я предлагаю вернуться к истокам этого простокола, который по сути является сердцем механизма обработки данных в Apache Kafka. Затем мы обсудим его ограничения и текущие улучшения.

## Kafka и Протокол Ребалансировки 101

### Давайте Начнем с Основ

Apache Kafka - это потоковая платформа, основанная на шаблоне рапределенных публикаций/подписок. Первым делом, процессы, называющиеся производителями (producers) отправляют сообщения в топики, которые управляются и хранятся кластерами брокеров. Затем, процессы, которые называются потребителями (consumers) подписываются на эти топики для получения и обработки опубликованных сообщений.

Топик, в общем случае, распределен между некоторым числом брокеров, таким образом, что каждый броке управляет некоторым подмножеством сообщений для каждого топика, эти подмножества называются партициями (partitions). Число партиций определяется во время создания топика и может расти с течением времени (однако будте внимательнее с этой операцией).

Что важно понимать это то, что партиция по сути является единицей параллелизма для производителей и потребителей Kafka.

Со стороны производителя, партиции продоставляют возможность записи сообщений параллельно. Если сообщение публикуется с ключом, тогда, по умолчанию, производитель будет хешировать данный ключ для определения того, в какую партицию должно быть положено сообщение. Это дает гарантию, что все сообщения с одинаковым ключом, будут отправлены в одну и ту же партицию. В добавок, со стороны потребителя, будут соблюдаться гарантии относительно порядка чтения сообщений из данной партиции.

Со стороны потребителя, число партиций для топика ограничено максимальным числом активных потребителей в группе потребителей. Группа потребитеоей это механизм, предоставляемый Kafka для группирования нескольких клиентов-потребителей в одну логическую группу, чтобы сбалансировать нагрузку на чтение разделов. Kafka гарантирует, что раздел темы будет назначен только одному потребителю в группе.

Например, на рисунке ниже изображена группа потребителей с именем A с тремя потребителями. Потребители подписались на тему A, и распределение разделов: P0 - C1, P1 - C2, P2 - C3 и P1.

![Apache Kafka — Consumer Group](https://miro.medium.com/max/1246/1*0qD0pg05zkYHn9jK0IxN1w.jpeg)

Если потребитель покидает группу потребителей либо после корректного выключения либо после аварийного падение, в этом случае все партиции топика будут автоматически переназначены оставшемся в группе потребителям. Аналогично, если потребитель (повторно) заходит в группу, тогда все партиции также будут перебалансированы между членами группы.

Возможность клиентам-потребителям работать в рамках динамической группы стала возможна благодаря использованию так называетмого протокола ребалансировки.

Давайте заглянем по-глубже и попытаемся понять, как работает этот протокол.

### Протокол ребалансировки в двух словах

Во-первых, давайте дадим определение понятию "ребалансировка" в терминах Apache Kafka.

> Ребалансировка - процедура, за которой следует ряд распределенных процессов, которые используют клиентов Kafka и/или координатора Kafka для формирования общей группы и распределения набора ресурсов между членами группы.
